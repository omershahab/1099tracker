{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Expenses</h2>

  <!-- Sticky Quick Add bar -->
  <div class="quick-add" id="qa">
    <form method="post" action="{{ url_for('add') }}" enctype="multipart/form-data" class="qa-form" id="qaForm">
      <input type="date" name="dt" id="qaDate" value="{{ today }}" required>
      <input type="text" name="vendor" id="qaVendor" placeholder="Vendor (e.g., Uber, Marriott)" autocomplete="off">
      <input type="text" name="amount" id="qaAmount" placeholder="$ Amount" inputmode="decimal" required>
      <select name="category" id="qaCategory">
        {% for c in categories %}<option>{{ c }}</option>{% endfor %}
      </select>
      <input type="text" name="description" id="qaDesc" placeholder="Description (optional)">
      <input type="hidden" name="tax_year" id="qaTaxYear" value="">
      <label class="chk"><input type="checkbox" name="is_deductible" checked> Deductible</label>
      <button type="submit" class="btn primary">Add</button>
      <button type="submit" class="btn" name="add_another" value="1">Add +</button>
    </form>
    <div class="qa-help">Tip: Amount accepts $ and commas. Last category is remembered.</div>
  </div>

  <details class="filters" open>
    <summary>Filters</summary>
    <form method="get" action="{{ url_for('list_expenses') }}" class="form-inline">
      <input type="number" name="year" value="{{ request.args.get('year','') }}" placeholder="Year (e.g., 2025)">
      <input type="number" min="1" max="12" name="month" value="{{ request.args.get('month','') }}" placeholder="Month">
      <select name="category">
        <option>All</option>
        {% for c in categories %}<option {{ 'selected' if request.args.get('category')==c else '' }}>{{ c }}</option>{% endfor %}
      </select>
      <input type="text" name="q" value="{{ request.args.get('q','') }}" placeholder="Search vendor/description/notes">
      <button type="submit" class="btn">Apply</button>
    </form>
  </details>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th><th>Vendor/Desc</th><th>Category</th><th>$</th><th>Miles</th><th>Calc</th><th>Receipt</th><th>â€”</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        {% set calc = (r['amount'] or 0) + ((r['miles'] or 0) * (r['mileage_rate'] or 0)) %}
        <tr>
          <td>{{ r['dt'] }}</td>
          <td><strong>{{ r['vendor'] }}</strong><br><small>{{ r['description'] }}</small></td>
          <td>{{ r['category'] }}</td>
          <td>{{ "%.2f"|format(r['amount'] or 0) }}</td>
          <td>{{ r['miles'] or 0 }}</td>
          <td>{{ "%.2f"|format(calc) }}</td>
          <td>{% if r['receipt_path'] %}<a href="{{ r['receipt_path'] }}" target="_blank">View</a>{% else %}-{% endif %}</td>
          <td>
            <form method="post" action="{{ url_for('delete_expense', expense_id=r['id']) }}" onsubmit="return confirm('Delete this expense?')">
              <button type="submit" class="btn danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="8" style="text-align:center;">No records found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<script>
(function(){
  const dateEl = document.getElementById('qaDate');
  const taxYearEl = document.getElementById('qaTaxYear');
  const catEl = document.getElementById('qaCategory');
  const vendEl = document.getElementById('qaVendor');
  const amtEl = document.getElementById('qaAmount');
  const form = document.getElementById('qaForm');

  function setTaxYear() {
    const val = dateEl.value || '';
    taxYearEl.value = (val || '').slice(0,4);
  }
  dateEl.addEventListener('change', setTaxYear);
  setTaxYear();

  const savedCat = localStorage.getItem('lastCategory');
  if (savedCat) {
    for (const o of catEl.options) if (o.value === savedCat) o.selected = true;
  }
  catEl.addEventListener('change', () => {
    localStorage.setItem('lastCategory', catEl.value);
  });

  const rules = [
    [/uber|lyft/i, 'Parking/Tolls'],
    [/marriott|hyatt|hilton|ihg|hampton|cvs|walgreens/i, 'Travel - Air/Hotel'],
    [/delta|united|american|southwest|jetblue/i, 'Travel - Air/Hotel'],
    [/starbucks|chipotle|restaurant|grill|cafe|pizza/i, 'Meals (50%)'],
    [/ama|abim|dea|state board|licen/i, 'Licensing/DEA/Board Fees'],
    [/uptodate|dynamed|epocrates|visualdx|micromedex/i, 'Medical Software/Subscriptions'],
    [/intuit|legal|cpa|attorney/i, 'Legal/Accounting'],
    [/verizon|att|t-mobile|comcast|xfinity|spectrum/i, 'Phone/Internet']
  ];
  vendEl.addEventListener('input', () => {
    const v = vendEl.value || '';
    for (const [re, cat] of rules) { if (re.test(v)) { catEl.value = cat; break; } }
  });

  form.addEventListener('submit', () => {
    amtEl.value = (amtEl.value || '').replace(/\$/g,'').replace(/,/g,'');
  });

  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.shiftKey) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'add_another';
      hidden.value = '1';
      form.appendChild(hidden);
    }
  });
})();
</script>
{% endblock %}
