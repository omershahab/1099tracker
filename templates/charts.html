{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Charts</h2>
  <div class="grid2">
    <div class="panel">
      <h3>By Category (toggle)</h3>
      <div class="toggle">
        <label><input type="radio" name="modePie" value="spent" checked> Spent</label>
        <label><input type="radio" name="modePie" value="deductible"> Deductible</label>
      </div>
      <canvas id="catPie"></canvas>
    </div>
    <div class="panel">
      <h3>Monthly Totals (toggle)</h3>
      <div class="toggle">
        <label><input type="radio" name="modeBar" value="spent" checked> Spent</label>
        <label><input type="radio" name="modeBar" value="deductible"> Deductible</label>
      </div>
      <canvas id="monthBar"></canvas>
    </div>
  </div>
</section>

<script>
(async function() {
  const year = new Date().getFullYear();

  async function loadTotals(mode) {
    const res = await fetch(`/api/totals?year=${year}&mode=${mode}`);
    return await res.json();
  }
  async function loadMonthly(mode) {
    const res = await fetch(`/api/monthly?year=${year}&mode=${mode}`);
    return await res.json();
  }

  // init
  let pieMode = 'spent', barMode = 'spent';
  let totals = await loadTotals(pieMode);
  const pieCtx = document.getElementById('catPie');
  const pie = new Chart(pieCtx, {
    type: 'pie',
    data: { labels: Object.keys(totals.by_category||{}), datasets: [{ data: Object.values(totals.by_category||{}) }] },
    options: { responsive: true }
  });

  let monthly = await loadMonthly(barMode);
  const barCtx = document.getElementById('monthBar');
  const bar = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      datasets: [{ label: `Total ${barMode} ${year}`, data: monthly.series||[] }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // toggles
  document.querySelectorAll('input[name="modePie"]').forEach(el => {
    el.addEventListener('change', async (e) => {
      pieMode = e.target.value;
      totals = await loadTotals(pieMode);
      pie.data.labels = Object.keys(totals.by_category||{});
      pie.data.datasets[0].data = Object.values(totals.by_category||{});
      pie.update();
    });
  });
  document.querySelectorAll('input[name="modeBar"]').forEach(el => {
    el.addEventListener('change', async (e) => {
      barMode = e.target.value;
      monthly = await loadMonthly(barMode);
      bar.data.datasets[0].label = `Total ${barMode} ${year}`;
      bar.data.datasets[0].data = monthly.series||[];
      bar.update();
    });
  });
})();
</script>
{% endblock %}
